name: Build
on: [push]
jobs:
  build-win:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v2

    - uses: actions/setup-dotnet@v1
      with:
        dotnet-version: '3.1.x'

    - name: Restore NuGet Packages
      run: nuget restore "CM Launcher.sln"

    - name: Build CML
      working-directory: ./Windows
      run: |
        dotnet build --configuration Release
        mv "bin/Release/CM Launcher.exe" "bin/Release/CML2.exe"

    - id: upload-file
      uses: google-github-actions/upload-cloud-storage@main
      with:
        credentials: ${{ secrets.gcp_credentials }}
        path: Windows/bin/Release/CML2.exe
        destination: chromapper
  build-osx:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v2

    - uses: maxim-lobanov/setup-xamarin@v1
      with:
        mono-version: latest
        xamarin-mac-version: latest
        xcode-version: latest

    - name: Restore NuGet Packages
      run: nuget restore "CM Launcher.sln"

    - name: Build CML
      working-directory: ./OSX
      run: |
        msbuild /property:Configuration=Release
        mkdir -p zip
        mv bin/Release/CML.app zip/CML.app
        chmod +x zip/CML.app/Contents/MacOS/CML

    - uses: papeloto/action-zip@v1
      with:
        files: OSX/zip
        dest: CML2.app.zip

    - id: upload-file
      uses: google-github-actions/upload-cloud-storage@main
      with:
        credentials: ${{ secrets.gcp_credentials }}
        path: CML2.app.zip
        destination: chromapper
  update-version:
    runs-on: ubuntu-latest
    needs: [build-osx, build-win]
    steps:
    - uses: actions/checkout@v2

    - name: Write version file
      run: grep -Po 'APP_VERSION = \K[0-9]+' Shared/Config.cs > cml2

    - id: upload-file
      uses: google-github-actions/upload-cloud-storage@main
      with:
        credentials: ${{ secrets.gcp_credentials }}
        path: cml2
        destination: chromapper
